---
- name: Include OS-specific variables.
  include_vars: "{{ item }}"
  with_first_found:
    - "../vars/{{ ansible_os_family }}_{{ ansible_distribution_major_version }}.yml"
    - "../vars/{{ ansible_os_family }}.yml"

- include: setup-RedHat.yml
  when: ansible_os_family == 'RedHat'

- include: setup-Debian.yml
  when: ansible_os_family == 'Debian'

# OS independent tasks
- name: Configure template iptables_v6
  template: 
    src: iptables_v4.j2
    dest:  "{{ iptables_v4_config }}"
    owner: root 
    group: root 
    mode: 0640
  notify:  restart iptables

- name: Configure template iptables_v6
  template:
    src: iptables_v6.j2
    dest:  "{{ iptables_v6_config }}"
    owner: root
    group: root
    mode: 0640
  notify:  restart iptables
  when: iptables_rules_v6_enabled | length > 0

- name: Ensure iptables service is enabled
  service: 
    name: "{{ iptables_service }}"
    enabled: yes
    state: started
  changed_when: false

- block:
    - name: Check firewall rules_v4
      shell: >
       iptables -L -n -v
      register: rules_v4
    - debug: var=rules_v4.stdout_lines
    - name: Check firewall rules_v6
      shell: >
        ip6tables -L -n -v
      register: rules_v6
    - debug: var=rules_v6.stdout_lines
  when: iptables_show_rules_v6 == true

#- name: Check firewall config
#  shell: cat "{{ iptables_v4_config }}"
#  register: command
#- debug: msg={{command.stdout_lines}}
